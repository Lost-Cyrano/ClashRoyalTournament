<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vérification d'email - Tournoi Clash Royal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --primary: #ffcc00;
            --secondary: #8a2be2;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: url('https://lost-cyrano.github.io/ClashRoyalTournament/background.jpeg') no-repeat center center fixed;
            background-size: cover;
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.85);
            z-index: -1;
        }
        
        .container {
            width: 90%;
            max-width: 600px;
            text-align: center;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .logo-title {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1rem;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            color: var(--primary);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        
        .icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }
        
        .success .icon {
            color: var(--success);
        }
        
        .error .icon {
            color: var(--danger);
        }
        
        .loading .icon {
            color: var(--primary);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(to right, var(--primary), #ffaa00);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin-top: 1.5rem;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .hidden {
            display: none;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://lost-cyrano.github.io/ClashRoyalTournament/images__4_-removebg-preview.png" alt="Clash Royal" class="logo-title">
        </div>
        
        <h1>Vérification d'email</h1>
        
        <!-- État de chargement -->
        <div class="card loading" id="loadingState">
            <div class="icon">
                <i class="fas fa-spinner spinner"></i>
            </div>
            <h2>Vérification en cours...</h2>
            <p>Veuillez patienter pendant que nous vérifions votre email.</p>
        </div>
        
        <!-- État de succès - Inscription -->
        <div class="card success hidden" id="successInscriptionState">
            <div class="icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Inscription Confirmée !</h2>
            <p id="successInscriptionMessage">Votre inscription au tournoi Clash Royal a été confirmée avec succès.</p>
            <a href="index.html" class="btn">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
        </div>
        
        <!-- État de succès - Connexion -->
        <div class="card success hidden" id="successConnexionState">
            <div class="icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Connexion Réussie !</h2>
            <p id="successConnexionMessage">Vous êtes maintenant connecté à votre compte.</p>
            <a href="selection-video.html" class="btn">
                <i class="fas fa-film"></i> Sélectionner une vidéo
            </a>
            <a href="index.html" class="btn" style="margin-left: 10px;">
                <i class="fas fa-home"></i> Accueil
            </a>
        </div>
        
        <!-- État d'erreur -->
        <div class="card error hidden" id="errorState">
            <div class="icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Erreur de vérification</h2>
            <p id="errorMessage">Une erreur s'est produite lors de la vérification de votre email.</p>
            <a href="index.html" class="btn">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
        </div>
    </div>

    <script>
    // Configuration Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAVR2UZVvlW6OAHf43iznqoErojYLCInbY",
        authDomain: "clashroyaltournament-e3a4f.firebaseapp.com",
        databaseURL: "https://clashroyaltournament-e3a4f-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "clashroyaltournament-e3a4f",
        storageBucket: "clashroyaltournament-e3a4f.firebasestorage.app",
        messagingSenderId: "903714952350",
        appId: "1:903714952350:web:076d357cab70ccfd0dd78f"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // Fonction pour décoder les données base64 URL-safe
    function decodeData(encodedData) {
        try {
            // Remplacer les caractères URL-safe
            const base64 = encodedData.replace(/-/g, '+').replace(/_/g, '/');
            // Ajouter le padding si nécessaire
            const padded = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');
            const jsonString = decodeURIComponent(escape(atob(padded)));
            return JSON.parse(jsonString);
        } catch (error) {
            throw new Error("Données corrompues");
        }
    }

    // Fonction pour extraire les données de l'URL Firebase (pour l'inscription)
    function extractDataFromFirebaseUrl() {
        try {
            // Récupérer le paramètre continueUrl de l'URL Firebase
            const urlParams = new URLSearchParams(window.location.search);
            const continueUrl = urlParams.get('continueUrl');
            
            if (!continueUrl) {
                throw new Error("Paramètre continueUrl manquant");
            }

            // Décoder l'URL (elle est encodée en URL)
            const decodedContinueUrl = decodeURIComponent(continueUrl);
            
            // Extraire le paramètre data de l'URL décodée
            const continueUrlParams = new URLSearchParams(new URL(decodedContinueUrl).search);
            const encodedData = continueUrlParams.get('data');
            
            if (!encodedData) {
                throw new Error("Données d'inscription manquantes dans continueUrl");
            }

            // Décoder les données
            return decodeData(encodedData);
            
        } catch (error) {
            console.error("Erreur lors de l'extraction des données:", error);
            throw new Error("Impossible de récupérer les données d'inscription");
        }
    }

    // Fonction pour appliquer la vérification d'email
    async function applyEmailVerification() {
        try {
            // Récupérer le code de vérification depuis l'URL Firebase
            const urlParams = new URLSearchParams(window.location.search);
            const oobCode = urlParams.get('oobCode');
            
            if (!oobCode) {
                throw new Error("Code de vérification manquant");
            }

            // Appliquer le code de vérification
            await auth.applyActionCode(oobCode);
            return { success: true };
        } catch (error) {
            console.error("Erreur lors de la vérification:", error);
            return { 
                success: false, 
                message: "Le lien de vérification est invalide ou a expiré." 
            };
        }
    }

    // Fonction pour gérer la connexion par lien magique
    async function handleSignInWithEmailLink() {
        try {
            // Récupérer l'email stocké localement
            const email = window.localStorage.getItem('emailForSignIn');
            
            if (!email) {
                throw new Error("Aucune session de connexion trouvée. Veuillez redémarrer le processus de connexion.");
            }

            // Vérifier si c'est un lien de connexion valide
            if (!auth.isSignInWithEmailLink(window.location.href)) {
                throw new Error("Ce lien de connexion n'est pas valide.");
            }

            // Effectuer la connexion
            const result = await auth.signInWithEmailLink(email, window.location.href);
            
            // Nettoyer l'email stocké
            window.localStorage.removeItem('emailForSignIn');
            
            return { 
                success: true, 
                user: result.user 
            };
        } catch (error) {
            console.error("Erreur lors de la connexion:", error);
            return { 
                success: false, 
                message: error.message 
            };
        }
    }

    // Fonction pour déterminer le type d'action (inscription ou connexion)
    function determineActionType() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Vérifier si c'est un lien de connexion
        if (auth.isSignInWithEmailLink(window.location.href)) {
            return 'connexion';
        }
        
        // Vérifier si c'est une vérification d'email classique
        const oobCode = urlParams.get('oobCode');
        const mode = urlParams.get('mode');
        
        if (oobCode && mode === 'verifyEmail') {
            return 'inscription';
        }
        
        return 'inconnu';
    }

    // Fonction pour finaliser l'inscription
    async function completeInscription(userData) {
        try {
            // Vérifier que l'email est bien vérifié
            const user = auth.currentUser;
            if (user) {
                await user.reload();
                if (!user.emailVerified) {
                    throw new Error("L'email n'est pas encore vérifié");
                }
            }

            // Vérifier si l'email existe déjà dans la base
            const emailSnapshot = await database.ref('inscriptions')
                .orderByChild('email')
                .equalTo(userData.email)
                .once('value');
            
            if (emailSnapshot.exists()) {
                throw new Error("Une inscription avec cet email existe déjà");
            }

            // Préparer les données finales avec un ID unique
            const inscriptionId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            
            const finalData = {
                ...userData,
                inscriptionId: inscriptionId,
                emailVerified: true,
                verifiedTimestamp: new Date().toISOString(),
                status: 'confirmed',
                source: 'verif_page'
            };

            // Sauvegarder dans la base de données
            await database.ref('inscriptions/' + inscriptionId).set(finalData);

            // JOURNALISATION - Inscription réussie
            try {
                const logRef = database.ref('logs/' + Date.now());
                await logRef.set({
                    timestamp: Date.now(),
                    action: 'email_verification_success',
                    userEmail: userData.email,
                    pageSource: 'verif_page',
                    inscriptionId: inscriptionId
                });
                console.log("Journalisation de l'inscription réussie");
            } catch (logError) {
                console.warn("Erreur de journalisation:", logError);
            }

            return { 
                success: true, 
                message: "Félicitations ! Votre inscription au tournoi Clash Royal a été confirmée avec succès." 
            };
        } catch (error) {
            console.error("Erreur lors de la finalisation de l'inscription:", error);
            
            // JOURNALISATION - Erreur d'inscription
            try {
                const logRef = database.ref('logs/' + Date.now());
                await logRef.set({
                    timestamp: Date.now(),
                    action: 'email_verification_error',
                    userEmail: userData.email,
                    pageSource: 'verif_page',
                    error: error.message
                });
            } catch (logError) {
                console.warn("Erreur de journalisation d'erreur:", logError);
            }
            
            return { 
                success: false, 
                message: error.message 
            };
        }
    }

    // Fonction pour afficher l'état de succès de connexion
    function showConnexionSuccess(user) {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('successConnexionState').classList.remove('hidden');
        document.getElementById('successConnexionMessage').textContent = 
            `Bienvenue ${user.email} ! Vous êtes maintenant connecté à votre compte.`;
    }

    // Fonction pour afficher l'état de succès d'inscription
    function showInscriptionSuccess(message) {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('successInscriptionState').classList.remove('hidden');
        document.getElementById('successInscriptionMessage').textContent = message;
    }

    // Fonction pour afficher l'état d'erreur
    function showError(message) {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('errorState').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = message;
    }

    // Fonction principale de vérification
    async function processVerification() {
        try {
            console.log("Début du processus de vérification...");
            
            // Déterminer le type d'action
            const actionType = determineActionType();
            console.log("Type d'action détecté:", actionType);
            
            if (actionType === 'connexion') {
                // Traitement pour la connexion par lien magique
                console.log("Traitement de la connexion par lien magique...");
                const connexionResult = await handleSignInWithEmailLink();
                
                if (connexionResult.success) {
                    console.log("Connexion réussie:", connexionResult.user.email);
                    showConnexionSuccess(connexionResult.user);
                } else {
                    throw new Error(connexionResult.message);
                }
                
            } else if (actionType === 'inscription') {
                // Traitement pour l'inscription classique
                console.log("Traitement de l'inscription...");
                
                // Étape 1: Extraire les données de l'URL Firebase
                console.log("Extraction des données depuis l'URL...");
                const userData = extractDataFromFirebaseUrl();
                console.log("Données extraites:", userData);

                // Étape 2: Appliquer la vérification d'email
                console.log("Application de la vérification d'email...");
                const verificationResult = await applyEmailVerification();
                
                if (!verificationResult.success) {
                    throw new Error(verificationResult.message);
                }
                console.log("Email vérifié avec succès");

                // Étape 3: Finaliser l'inscription
                console.log("Finalisation de l'inscription...");
                const inscriptionResult = await completeInscription(userData);

                if (inscriptionResult.success) {
                    showInscriptionSuccess(inscriptionResult.message);
                    console.log("Inscription finalisée avec succès");
                } else {
                    throw new Error(inscriptionResult.message);
                }
                
            } else {
                throw new Error("Type d'action non reconnu. Ce lien semble être invalide.");
            }
            
        } catch (error) {
            console.error("Erreur de vérification:", error);
            showError(error.message);
        }
    }

    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', function() {
        console.log("URL complète:", window.location.href);
        console.log("Paramètres URL:", window.location.search);
        processVerification();
    });
</script>
</body>
</html>
