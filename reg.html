<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournoi Clash Royal MDL 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .hidden { display: none; }
        .user-info { background: #f8f9fa; padding: 15px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tournoi Clash Royal MDL 2026</h1>
        
        <!-- Section connexion -->
        <div id="loginSection">
            <h2>Connexion</h2>
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" required>
            </div>
            <button onclick="sendLoginLink()">Envoyer le lien de connexion</button>
        </div>

        <!-- Section utilisateur connecté -->
        <div id="userSection" class="hidden">
            <div class="user-info">
                <h3>Bienvenue <span id="userEmail"></span>!</h3>
                <p>Vous êtes connecté avec succès.</p>
                <button onclick="logout()">Déconnexion</button>
            </div>
        </div>

        <!-- Formulaire d'inscription (seulement pour utilisateurs connectés) -->
        <div id="registrationSection" class="hidden">
            <h2>Inscription au Tournoi</h2>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">Prénom:</label>
                    <input type="text" id="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Nom:</label>
                    <input type="text" id="lastName" required>
                </div>
                <div class="form-group">
                    <label for="playerClass">Classe de joueur:</label>
                    <select id="playerClass" required>
                        <option value="">Sélectionnez</option>
                        <option value="Premiere">Première</option>
                        <option value="Seconde">Seconde</option>
                        <option value="Cadet">Cadet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trophies">Nombre de trophées:</label>
                    <input type="number" id="trophies" required>
                </div>
                <div class="form-group">
                    <label for="phone">Téléphone:</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="membership">Numéro d'adhésion:</label>
                    <input type="text" id="membership" required>
                </div>
                <div class="form-group">
                    <label for="tshirtSize">Taille T-shirt:</label>
                    <select id="tshirtSize" required>
                        <option value="">Sélectionnez</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gender">Genre:</label>
                    <select id="gender" required>
                        <option value="">Sélectionnez</option>
                        <option value="Garçon">Garçon</option>
                        <option value="Fille">Fille</option>
                        <option value="Garçon">Garçon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tshirtColor">Couleur T-shirt:</label>
                    <select id="tshirtColor" required>
                        <option value="">Sélectionnez</option>
                        <option value="rouge">Rouge</option>
                        <option value="bleu">Bleu</option>
                        <option value="vert">Vert</option>
                        <option value="noir">Noir</option>
                        <option value="blanc">Blanc</option>
                    </select>
                </div>
                <button type="submit">S'inscrire au tournoi</button>
            </form>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAVR2UZVvlW6OAHf43iznqoErojYLCInbY",
            authDomain: "clashroyaltournament-5d1d7.firebaseapp.com",
            projectId: "clashroyaltournament-5d1d7",
            storageBucket: "clashroyaltournament-5d1d7.firebasestorage.app",
            messagingSenderId: "522424",
            appId: "1:522424:web:b4d9b2a9c3c0c0c0c0c0c0"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Vérifier l'état de connexion
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Utilisateur connecté
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userSection').classList.remove('hidden');
                document.getElementById('registrationSection').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                
                // Vérifier si l'utilisateur est déjà inscrit
                checkExistingRegistration(user.uid);
            } else {
                // Utilisateur non connecté
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('userSection').classList.add('hidden');
                document.getElementById('registrationSection').classList.add('hidden');
            }
        });

        // Fonction pour envoyer le lien de connexion
        async function sendLoginLink() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                alert('Veuillez saisir votre email');
                return;
            }

            const actionCodeSettings = {
                url: 'https://lost-cyrano.github.io/ClashRoyalTournament/verif.html?mode=signIn',
                handleCodeInApp: true
            };

            try {
                await auth.sendSignInLinkToEmail(email, actionCodeSettings);
                
                // Sauvegarder l'email localement
                window.localStorage.setItem('emailForSignIn', email);
                
                alert('Lien de connexion envoyé à ' + email + '. Vérifiez votre boîte email.');
            } catch (error) {
                console.error('Erreur envoi lien:', error);
                alert('Erreur: ' + error.message);
            }
        }

        // Déconnexion
        function logout() {
            auth.signOut();
        }

        // Vérifier si l'utilisateur est déjà inscrit
        async function checkExistingRegistration(uid) {
            try {
                const doc = await db.collection('registrations').doc(uid).get();
                if (doc.exists) {
                    // L'utilisateur est déjà inscrit, pré-remplir le formulaire
                    const data = doc.data();
                    document.getElementById('firstName').value = data.firstName || '';
                    document.getElementById('lastName').value = data.lastName || '';
                    document.getElementById('playerClass').value = data.class || '';
                    document.getElementById('trophies').value = data.trophies || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('membership').value = data.membership || '';
                    document.getElementById('tshirtSize').value = data.size || '';
                    document.getElementById('gender').value = data.gender || '';
                    document.getElementById('tshirtColor').value = data.color || '';
                    
                    alert('Vous êtes déjà inscrit au tournoi. Vous pouvez modifier vos informations si nécessaire.');
                }
            } catch (error) {
                console.error('Erreur vérification inscription:', error);
            }
        }

        // Gestion du formulaire d'inscription
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                alert('Veuillez vous connecter d\'abord');
                return;
            }

            const registrationData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                class: document.getElementById('playerClass').value,
                trophies: parseInt(document.getElementById('trophies').value),
                phone: document.getElementById('phone').value,
                email: user.email,
                membership: document.getElementById('membership').value,
                size: document.getElementById('tshirtSize').value,
                gender: document.getElementById('gender').value,
                color: document.getElementById('tshirtColor').value,
                uid: user.uid,
                timestamp: new Date()
            };

            try {
                await db.collection('registrations').doc(user.uid).set(registrationData);
                alert('Inscription réussie! Merci pour votre participation au tournoi.');
            } catch (error) {
                console.error('Erreur inscription:', error);
                alert('Erreur lors de l\'inscription: ' + error.message);
            }
        });
    </script>
</body>
</html>
